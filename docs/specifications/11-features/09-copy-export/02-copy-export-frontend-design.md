# 複製・エクスポート フロントエンド設計書

## 1. フロントエンド設計

### 1.1 画面一覧

複製・エクスポート機能は専用の新規画面を持たず、既存画面に機能を追加します。

| 画面名 | 画面パス | 追加機能 | 実装状況 |
|-------|---------|---------|---------|
| セッション一覧 | `/projects/{id}/sessions` | セッション複製ボタン | 実装済 |
| 分析画面 | `/projects/{id}/analysis/{id}` | 分析結果エクスポートボタン | 未実装 |
| ツリー一覧 | `/projects/{id}/trees` | ツリー複製ボタン | 実装済 |
| 計算結果画面 | `/projects/{id}/trees/{id}/results` | ツリー計算結果エクスポートボタン | 実装済 |
| ノード編集パネル | `/projects/{id}/trees/{id}/edit` | ノードデータダウンロードボタン | 実装済 |

### 1.2 コンポーネント構成

#### ボタンコンポーネント

| コンポーネント | 配置場所 | APIエンドポイント | トリガーアクション |
|--------------|---------|------------------|------------------|
| 複製ボタン (Session) | セッション一覧の各行 | POST /session/{id}/duplicate | 複製確認ダイアログを表示 |
| 複製ボタン (Tree) | ツリー一覧の各行 | POST /tree/{id}/duplicate | 複製確認ダイアログを表示 |
| エクスポートボタン (Session) | 分析画面ヘッダー | GET /session/{id}/export | エクスポートオプションダイアログを表示 |
| エクスポートボタン (Tree) | 計算結果画面ヘッダー | GET /tree/{id}/output | ファイルダウンロード |
| データダウンロードボタン | ノード編集パネル | GET /node/{id}/preview/output | CSVファイルダウンロード |

#### ダイアログコンポーネント

**複製確認ダイアログ**

```text
┌────────────────────────────────────────┐
│  セッションを複製                        │
├────────────────────────────────────────┤
│  新しいセッション名:                     │
│  ┌──────────────────────────────────┐  │
│  │ Q4売上分析 (コピー)              │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ☑ スナップショットも複製する           │
│                                        │
├────────────────────────────────────────┤
│  [キャンセル]              [複製する]   │
└────────────────────────────────────────┘
```

**エクスポートオプションダイアログ**

```text
┌────────────────────────────────────────┐
│  分析結果をエクスポート                  │
├────────────────────────────────────────┤
│  ファイル形式:                          │
│  ○ Excel (.xlsx)                       │
│  ○ CSV (.csv)                          │
│  ○ PDF (.pdf)                          │
│                                        │
│  含めるデータ:                          │
│  ☑ ステップ詳細                        │
│  ☑ チャット履歴                        │
│                                        │
├────────────────────────────────────────┤
│  [キャンセル]           [エクスポート]   │
└────────────────────────────────────────┘
```

---

## 2. 画面詳細設計

### 2.1 セッション複製

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|------|------------------|---------------------|---------------|
| セッション名 | テキスト | - | POST /session/{id}/duplicate | name | 省略時は自動生成 |
| スナップショット複製 | チェックボックス | - | POST /session/{id}/duplicate | includeSnapshots | デフォルトtrue |
| 複製ボタン | ボタン | - | POST /session/{id}/duplicate | - | - |

### 2.2 ツリー複製

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|------|------------------|---------------------|---------------|
| ツリー名 | テキスト | - | POST /tree/{id}/duplicate | name | 省略時は自動生成 |
| 複製ボタン | ボタン | - | POST /tree/{id}/duplicate | - | - |

### 2.3 セッションエクスポート

| 画面項目 | 入力形式 | APIエンドポイント | クエリパラメータ | 値 |
|---------|---------|------------------|-----------------|-----|
| Excel形式 | ラジオ | GET /session/{id}/export | format | xlsx |
| CSV形式 | ラジオ | GET /session/{id}/export | format | csv |
| PDF形式 | ラジオ | GET /session/{id}/export | format | pdf |
| ステップ詳細 | チェックボックス | GET /session/{id}/export | include_steps | true/false |
| チャット履歴 | チェックボックス | GET /session/{id}/export | include_chat | true/false |

### 2.4 ツリーエクスポート

| 画面項目 | 入力形式 | APIエンドポイント | クエリパラメータ | 値 |
|---------|---------|------------------|-----------------|-----|
| Excel形式 | ラジオ | GET /tree/{id}/output | format | xlsx |
| CSV形式 | ラジオ | GET /tree/{id}/output | format | csv |
| エクスポートボタン | ボタン | GET /tree/{id}/output | - | - |

---

## 3. 画面項目・APIマッピング

### 3.1 セッション複製

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| セッション名 | テキスト | - | `POST /session/{id}/duplicate` | `name` | 省略時は自動生成 |
| スナップショット複製 | チェックボックス | - | 同上 | `includeSnapshots` | デフォルトtrue |

### 3.2 ツリー複製

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| ツリー名 | テキスト | - | `POST /tree/{id}/duplicate` | `name` | 省略時は自動生成 |

### 3.3 エクスポート

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| ファイル形式 | ラジオ | ✓ | `GET /session/{id}/export` | `format` | xlsx/csv/pdf |
| ステップ詳細含む | チェックボックス | - | 同上 | `include_steps` | true/false |
| チャット履歴含む | チェックボックス | - | 同上 | `include_chat` | true/false |

---

## 4. API呼び出しタイミング

| トリガー | API呼び出し | 備考 |
|---------|------------|------|
| 複製ボタンクリック | - | 確認ダイアログ表示 |
| 複製確認 | `POST /session/{id}/duplicate` | ダイアログ送信時 |
| ツリー複製確認 | `POST /tree/{id}/duplicate` | ダイアログ送信時 |
| エクスポートボタンクリック | - | オプションダイアログ表示 |
| エクスポート実行 | `GET /session/{id}/export` | ファイルダウンロード |
| ツリーエクスポート | `GET /tree/{id}/output` | ファイルダウンロード |
| ノードデータダウンロード | `GET /node/{id}/preview/output` | CSVダウンロード |

---

## 5. エラーハンドリング

| エラー | 対応 |
|-------|------|
| 401 Unauthorized | ログイン画面にリダイレクト |
| 403 Forbidden | アクセス権限がありませんメッセージ表示 |
| 404 Not Found | 対象が見つかりませんメッセージ表示 |
| 500 Server Error | エラー画面を表示、リトライボタン |
| ダウンロードエラー | "ファイルのダウンロードに失敗しました"メッセージ表示 |

---

## 6. パフォーマンス考慮

| 項目 | 対策 |
|-----|------|
| 複製処理 | 非同期処理で大きなセッションも対応 |
| エクスポート | ストリーミングダウンロードで大容量ファイル対応 |
| UI応答性 | 処理中はローディング表示、キャンセル可能 |

---

## 7. ユースケースカバレッジ表

| UC ID | 機能名 | API | 画面コンポーネント | ステータス |
|-------|-------|-----|-------------------|-----------|
| CP-001 | 分析セッション複製 | `POST /session/{id}/duplicate` | sessions | 実装済 |
| CP-002 | ドライバーツリー複製 | `POST /tree/{id}/duplicate` | trees | 実装済 |
| EX-001 | 分析結果エクスポート | `GET /session/{id}/export` | analysis | 未実装 |
| EX-002 | ツリー計算結果エクスポート | `GET /tree/{id}/output` | tree-results | 実装済 |
| EX-003 | ノードデータエクスポート | `GET /node/{id}/preview/output` | tree-edit | 実装済 |

---

## 8. 関連ドキュメント

- **バックエンド設計書**: [01-copy-export-design.md](./01-copy-export-design.md)
- **API共通仕様**: [../01-api-overview/01-api-overview.md](../01-api-overview/01-api-overview.md)

---

## 9. ドキュメント管理情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | CE-FRONTEND-001 |
| 対象ユースケース | CP-001〜CP-002, EX-001〜EX-003 |
| 最終更新日 | 2026-01-01 |
| 対象フロントエンド | `features/copy-export/` |

# ファイル管理・バージョン管理 フロントエンド設計書

## 1. フロントエンド設計

### 1.1 画面一覧

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| files | ファイル一覧 | /projects/{id}/files | プロジェクト全体のファイル一覧 |
| upload | ファイルアップロード | /projects/{id}/files/upload | 新規ファイルアップロード |
| file-versions | バージョン履歴 | /projects/{id}/files/{fileId}/versions | ファイルのバージョン一覧・操作 |

### 1.2 コンポーネント構成

#### コンポーネント階層

```text
features/file-management/
├── components/
│   ├── FileList/
│   │   ├── FileList.tsx              # ファイル一覧テーブル
│   │   ├── FileListItem.tsx          # ファイル行
│   │   ├── FileSearchBar.tsx         # 検索・フィルタバー
│   │   └── FileTypeFilter.tsx        # ファイルタイプフィルタ
│   ├── FileUpload/
│   │   ├── FileUploadPage.tsx        # アップロード画面
│   │   ├── DropZone.tsx              # ドラッグ&ドロップエリア
│   │   ├── FileSelector.tsx          # ファイル選択ボタン
│   │   └── UploadProgress.tsx        # アップロード進捗
│   ├── VersionList/
│   │   ├── VersionList.tsx           # バージョン一覧
│   │   ├── VersionItem.tsx           # バージョン項目
│   │   └── VersionTimeline.tsx       # タイムライン表示
│   ├── VersionUpload/
│   │   ├── VersionUploadModal.tsx    # バージョンアップロードモーダル
│   │   └── VersionCommentInput.tsx   # コメント入力
│   ├── VersionCompare/
│   │   ├── VersionCompareModal.tsx   # 比較モーダル
│   │   ├── VersionSelector.tsx       # バージョン選択
│   │   └── ComparisonResult.tsx      # 比較結果表示
│   └── VersionActions/
│       ├── DownloadButton.tsx        # ダウンロードボタン
│       └── RestoreButton.tsx         # 復元ボタン
├── hooks/
│   ├── useFileList.ts                # ファイル一覧管理
│   ├── useFileUpload.ts              # ファイルアップロード
│   ├── useFileVersions.ts            # バージョン管理
│   └── useVersionCompare.ts          # バージョン比較
├── api/
│   ├── fileApi.ts                    # ファイルAPI
│   └── fileVersionApi.ts             # バージョンAPI
└── types/
    ├── file.ts                       # ファイル型定義
    └── fileVersion.ts                # バージョン型定義
```

#### 画面遷移フロー

```text
[ファイル一覧 (files)]
    │
    ├─→ [ファイルアップロード (upload)]
    │       │
    │       └─→ アップロード完了 → [ファイル一覧]
    │
    └─→ ファイル名クリック → [バージョン履歴 (file-versions)]
            │
            ├─→ [新規バージョンアップロード]
            │       │
            │       └─→ アップロード完了 → [バージョン履歴]
            │
            ├─→ [バージョン比較モーダル]
            │       │
            │       └─→ 閉じる → [バージョン履歴]
            │
            └─→ [バージョン復元]
                    │
                    └─→ 復元完了 → [バージョン履歴]（新バージョンとして追加）
```

**主要な遷移:**

1. **ファイル一覧 → アップロード画面**: 「新規アップロード」ボタンから遷移
2. **ファイル一覧 → バージョン履歴**: ファイル名クリックで該当ファイルのバージョン履歴画面へ
3. **バージョン履歴 → 比較モーダル**: 「比較」ボタンでモーダル表示
4. **バージョン履歴 → 復元**: 「復元」ボタンで確認ダイアログ表示後、復元実行

#### UI設計

##### ファイル一覧画面

```text
┌────────────────────────────────────────────────────────────────┐
│  プロジェクトファイル                      [新規アップロード]  │
├────────────────────────────────────────────────────────────────┤
│  検索: [____________]  種別: [すべて ▼]                        │
├────────────────────────────────────────────────────────────────┤
│  ファイル名          │ タイプ │ サイズ │ 更新者   │ 更新日時    │
├──────────────────────┼────────┼────────┼──────────┼────────────┤
│  📄 sales_data.xlsx  │ Excel  │ 1.0MB  │ 山田太郎 │ 2026/01/01 │
│  (v3)                │        │        │          │ 10:00      │
│  [ダウンロード] [履歴]                                          │
├──────────────────────┼────────┼────────┼──────────┼────────────┤
│  📄 proposal.pdf     │ PDF    │ 2.5MB  │ 鈴木花子 │ 2025/12/28 │
│  (v1)                │        │        │          │ 15:30      │
│  [ダウンロード] [履歴]                                          │
├──────────────────────┼────────┼────────┼──────────┼────────────┤
│  📄 design.psd       │ 画像   │ 15MB   │ 佐藤次郎 │ 2025/12/25 │
│  (v2)                │        │        │          │ 09:15      │
│  [ダウンロード] [履歴]                                          │
└────────────────────────────────────────────────────────────────┘
```

**機能:**

1. **検索・フィルタ**: ファイル名検索（部分一致）、ファイルタイプフィルタ
2. **テーブル項目**: ファイル名、現在バージョン、タイプ、サイズ、更新者、更新日時
3. **操作**: ダウンロード、履歴表示

##### アップロード画面

```text
┌────────────────────────────────────────────────────────────────┐
│  ファイルアップロード                                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│   ┌────────────────────────────────────────────────────────┐  │
│   │          📁  ここにファイルをドラッグ&ドロップ         │  │
│   │                  または                                │  │
│   │              [ファイルを選択]                          │  │
│   └────────────────────────────────────────────────────────┘  │
│                                                                │
│   対応フォーマット: Excel (.xlsx, .xls), PDF, Word, 画像      │
│   最大ファイルサイズ: 50MB                                    │
│                                                                │
│   選択ファイル:                                                │
│   ┌──────────────────────────────────────────────────────┐    │
│   │  📄 sales_report_2026.xlsx                           │    │
│   │  サイズ: 1.2MB                                       │    │
│   │  [×]                                                 │    │
│   └──────────────────────────────────────────────────────┘    │
│                                                                │
│   コメント: [_____________________________________]            │
│                                                                │
│                                   [キャンセル] [アップロード]  │
└────────────────────────────────────────────────────────────────┘
```

**機能:**

1. **ドラッグ&ドロップエリア**: ファイル選択、対応フォーマット表示
2. **ファイル選択**: ファイルプレビュー、選択解除
3. **アップロード進捗**: プログレスバー、キャンセル機能
4. **コメント入力**: 任意コメント入力

##### バージョン履歴画面

```text
┌────────────────────────────────────────────────────────┐
│  sales_data.xlsx のバージョン履歴                       │
│  現在: v3                                    [新規 ▲]  │
├────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────┐   │
│  │ ● v3 (現在)                     2026/01/01    │   │
│  │   Q4データ追加                                  │   │
│  │   山田 太郎 • 1.0 MB                           │   │
│  │   [ダウンロード]                               │   │
│  └────────────────────────────────────────────────┘   │
│        │                                               │
│  ┌────────────────────────────────────────────────┐   │
│  │ ○ v2                           2025/12/15     │   │
│  │   Q3データ修正                                  │   │
│  │   鈴木 花子 • 512 KB                           │   │
│  │   [ダウンロード] [復元] [比較]                   │   │
│  └────────────────────────────────────────────────┘   │
│        │                                               │
│  ┌────────────────────────────────────────────────┐   │
│  │ ○ v1                           2025/12/01     │   │
│  │   初回アップロード                              │   │
│  │   山田 太郎 • 256 KB                           │   │
│  │   [ダウンロード] [復元] [比較]                   │   │
│  └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

##### バージョン比較モーダル

```text
┌────────────────────────────────────────────────────────┐
│  バージョン比較                              [×]       │
├────────────────────────────────────────────────────────┤
│  比較元: [v2 ▼]  →  比較先: [v3 ▼]                    │
├────────────────────────────────────────────────────────┤
│  ファイルサイズ: 512 KB → 1.0 MB (+100%)              │
├────────────────────────────────────────────────────────┤
│  シート別変更:                                         │
│  ┌──────────────────────────────────────────────────┐ │
│  │ Sheet1                                           │ │
│  │   行: +150行 / -0行                              │ │
│  │   列: +2列 / -0列                                │ │
│  └──────────────────────────────────────────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ Sheet2                                           │ │
│  │   行: +50行 / -10行                              │ │
│  │   列: 変更なし                                   │ │
│  └──────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────┤
│                                         [閉じる]       │
└────────────────────────────────────────────────────────┘
```

---

## 2. 画面詳細設計

### 2.1 ファイル一覧画面（files）

#### 画面項目・APIマッピング

| 画面項目 | 表示形式 | APIエンドポイント | レスポンスフィールド | 変換処理 |
|---------|---------|------------------|---------------------|---------|
| ファイル名 | テキスト | GET /project/{id}/files | files[].name | - |
| 現在バージョン | テキスト | GET /project/{id}/files | files[].currentVersion | "v" + n |
| ファイルタイプ | テキスト | GET /project/{id}/files | files[].fileType | アイコン表示 |
| ファイルサイズ | テキスト | GET /project/{id}/files | files[].fileSize | KB/MB変換 |
| 最終更新者 | テキスト | GET /project/{id}/files | files[].updatedByName | - |
| 最終更新日時 | 日時 | GET /project/{id}/files | files[].updatedAt | YYYY/MM/DD HH:mm形式 |
| 検索入力 | テキスト | GET /project/{id}/files?search= | search | クエリパラメータ |
| タイプフィルタ | セレクト | GET /project/{id}/files?fileType= | fileType | クエリパラメータ |
| ダウンロードボタン | ボタン | GET /project/{id}/file/{fileId}/download | - | ファイルDL |
| 履歴ボタン | リンク | - | - | バージョン履歴画面へ遷移 |

#### 必要なAPI

**GET /api/v1/project/{project_id}/files**

プロジェクト内の全ファイル一覧を取得

**クエリパラメータ:**
- search: ファイル名検索（部分一致）
- fileType: ファイルタイプフィルタ（excel, pdf, image, other）
- page, limit: ページネーション

**レスポンス:**
```json
{
  "files": [
    {
      "fileId": "uuid",
      "name": "sales_data.xlsx",
      "fileType": "excel",
      "fileSize": 1048576,
      "currentVersion": 3,
      "updatedBy": "uuid",
      "updatedByName": "山田 太郎",
      "updatedAt": "2026-01-01T10:00:00Z",
      "createdAt": "2025-12-01T00:00:00Z"
    }
  ],
  "total": 15,
  "page": 1,
  "limit": 20
}
```

### 2.2 アップロード画面（upload）

#### 画面項目・APIマッピング

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|------|------------------|---------------------|---------------|
| ファイル | ファイル選択 | ○ | POST /project/{id}/files | file | 最大50MB、対応フォーマット |
| コメント | テキスト | - | POST /project/{id}/files | comment | 最大500文字 |
| アップロードボタン | ボタン | - | POST /project/{id}/files | - | - |

#### 必要なAPI

**POST /api/v1/project/{project_id}/files**

新規ファイルをアップロード

**リクエスト:**
- Content-Type: multipart/form-data
- file: File（必須）
- comment: string（任意）

**レスポンス:**
```json
{
  "fileId": "uuid",
  "name": "sales_report_2026.xlsx",
  "fileType": "excel",
  "fileSize": 1258291,
  "currentVersion": 1,
  "comment": "2026年売上レポート",
  "uploadedBy": "uuid",
  "uploadedByName": "山田 太郎",
  "createdAt": "2026-01-01T00:00:00Z"
}
```

### 2.3 バージョン履歴画面（file-versions）

#### 画面項目・APIマッピング

| 画面項目 | 表示形式 | APIエンドポイント | レスポンスフィールド | 変換処理 |
|---------|---------|------------------|---------------------|---------|
| ファイル名 | テキスト | GET /file/{id}/version | fileName | - |
| 現在バージョン | テキスト | GET /file/{id}/version | currentVersion | "v" + n |
| バージョン番号 | テキスト | GET /file/{id}/version | versions[].versionNumber | "v" + n |
| 現在フラグ | バッジ | GET /file/{id}/version | versions[].isCurrent | "現在" バッジ |
| 日時 | 日時 | GET /file/{id}/version | versions[].createdAt | YYYY/MM/DD形式 |
| コメント | テキスト | GET /file/{id}/version | versions[].comment | - |
| アップロード者 | テキスト | GET /file/{id}/version | versions[].uploadedByName | - |
| ファイルサイズ | テキスト | GET /file/{id}/version | versions[].fileSize | KB/MB変換 |
| ダウンロードボタン | ボタン | GET /file/{id}/version/{versionId} | - | ファイルDL |
| 復元ボタン | ボタン | POST /version/{id}/restore | - | 確認ダイアログ |
| 比較ボタン | ボタン | - | - | 比較モーダル表示 |

#### 新規バージョンアップロード

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|------|------------------|---------------------|---------------|
| ファイル | ファイル選択 | ○ | POST /file/{id}/version | file | 同名・同形式のみ |
| コメント | テキスト | - | POST /file/{id}/version | comment | 最大500文字 |
| アップロードボタン | ボタン | - | POST /file/{id}/version | - | - |

### 2.4 バージョン比較モーダル

#### 画面項目・APIマッピング

| 画面項目 | 入力/表示形式 | APIエンドポイント | パラメータ/フィールド | 変換処理 |
|---------|-------------|------------------|---------------------|---------|
| 比較元バージョン | セレクト | GET /file/{id}/version/compare | version1 | - |
| 比較先バージョン | セレクト | GET /file/{id}/version/compare | version2 | - |
| サイズ変更 | テキスト | GET /compare | comparison.sizeChange | +n KB / -n KB |
| サイズ変更率 | テキスト | GET /compare | comparison.sizeChangePercent | +n% / -n% |
| シート変更一覧 | リスト | GET /compare | comparison.sheetChanges[] | - |
| 行追加数 | テキスト | GET /compare | sheetChanges[].rowsAdded | +n行 |
| 行削除数 | テキスト | GET /compare | sheetChanges[].rowsRemoved | -n行 |

---

## 3. 画面項目・APIマッピング

### 3.1 ファイル一覧取得

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| ファイル名検索 | テキスト | - | `GET /project/{id}/files` | `search` | 部分一致 |
| タイプフィルタ | セレクト | - | 同上 | `fileType` | excel/pdf/image/other |
| ページ | 数値 | - | 同上 | `page` | 1以上 |
| 取得件数 | 数値 | - | 同上 | `limit` | デフォルト20 |

### 3.2 ファイルアップロード

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| ファイル | ファイル選択 | ✓ | `POST /project/{id}/files` | `file` | 最大50MB |
| コメント | テキスト | - | 同上 | `comment` | 最大500文字 |

### 3.3 バージョン操作

| 画面項目 | 入力形式 | 必須 | APIエンドポイント | リクエストフィールド | バリデーション |
|---------|---------|-----|------------------|---------------------|---------------|
| 新規バージョンファイル | ファイル選択 | ✓ | `POST /file/{id}/version` | `file` | 同名・同形式 |
| コメント | テキスト | - | 同上 | `comment` | 最大500文字 |

---

## 4. API呼び出しタイミング

| トリガー | API呼び出し | 備考 |
|---------|------------|------|
| ファイル一覧ページ表示 | `GET /project/{id}/files` | 初期ロード |
| 検索実行 | `GET /project/{id}/files?search=` | デバウンス300ms |
| タイプフィルタ変更 | `GET /project/{id}/files?fileType=` | 再取得 |
| アップロードボタン | `POST /project/{id}/files` | multipart/form-data |
| ファイル名クリック | - | バージョン履歴画面へ遷移 |
| バージョン履歴表示 | `GET /file/{id}/version` | - |
| 新規バージョンアップロード | `POST /file/{id}/version` | multipart/form-data |
| バージョン復元 | `POST /version/{id}/restore` | 確認後 |
| バージョン比較 | `GET /file/{id}/version/compare` | モーダル表示 |
| ダウンロード | `GET /file/{id}/version/{versionId}` | ファイルDL |

---

## 5. エラーハンドリング

| エラー | 対応 |
|-------|------|
| 401 Unauthorized | ログイン画面にリダイレクト |
| 403 Forbidden | アクセス権限がありませんメッセージ表示 |
| 404 Not Found | ファイルが見つかりませんメッセージ表示 |
| 413 Payload Too Large | ファイルサイズが制限を超えていますメッセージ表示 |
| 415 Unsupported Media Type | 対応していないファイル形式ですメッセージ表示 |
| 422 Validation Error | フォームエラー表示 |
| 500 Server Error | エラー画面を表示、リトライボタン |

---

## 6. パフォーマンス考慮

| 項目 | 対策 |
|-----|------|
| 一覧取得 | ページネーションで件数制限（デフォルト20件） |
| アップロード | プログレス表示、チャンクアップロード対応 |
| ダウンロード | ストリーミングダウンロードで大容量ファイル対応 |
| 検索 | 300msデバウンスでAPI呼び出しを最適化 |
| キャッシュ | React Query でファイル一覧を5分間キャッシュ |

---

## 7. ユースケースカバレッジ表

| UC ID | 機能名 | API | 画面コンポーネント | ステータス |
|-------|-------|-----|-------------------|-----------|
| FV-001 | バージョン一覧表示 | `GET /file/{id}/version` | file-versions | 設計済 |
| FV-002 | 新規バージョンアップロード | `POST /file/{id}/version` | VersionUploadModal | 設計済 |
| FV-003 | バージョン復元 | `POST /version/{id}/restore` | file-versions | 設計済 |
| FV-004 | バージョン比較 | `GET /file/{id}/version/compare` | VersionCompareModal | 設計済 |

---

## 8. 関連ドキュメント

- **バックエンド設計書**: [01-file-version-design.md](./01-file-version-design.md)
- **API共通仕様**: [../01-api-overview/01-api-overview.md](../01-api-overview/01-api-overview.md)
- **プロジェクト管理設計書**: [../04-project-management/01-project-management-design.md](../04-project-management/01-project-management-design.md)

---

## 9. ドキュメント管理情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | FV-FRONTEND-001 |
| 対象ユースケース | FV-001〜FV-004 |
| 最終更新日 | 2026-01-01 |
| 対象フロントエンド | `features/file-management/` |

a# セキュリティ実装ドキュメント

このドキュメントでは、AI Agent Application（FastAPIバックエンド）に実装されているセキュリティ機能の概要を説明します。

## 目次

- [概要](#概要)
- [実装済みセキュリティ機能](#実装済みセキュリティ機能)
- [詳細ドキュメント](#詳細ドキュメント)
- [まとめ](#まとめ)
- [参考資料](#参考資料)

---

## 概要

AI Agent Applicationは、基本的なセキュリティ要件を満たす堅牢な実装を提供しています。このドキュメントは、実装されているセキュリティ機能の全体像を示し、各詳細ドキュメントへのリンクを提供します。

### 実装済みセキュリティ機能

- JWT認証とbcryptパスワードハッシュ化
- リフレッシュトークン（ハッシュ化保存、7日間有効）
- APIキー認証（ハッシュ化保存）
- Redisベースのレート制限（スライディングウィンドウ）
- ログイン失敗回数制限（5回失敗で1時間ロック）
- セキュリティヘッダーミドルウェア（X-Frame-Options、HSTS等）
- 環境別CORS設定と本番環境での厳格な制御
- SQLAlchemy ORMによるSQLインジェクション対策
- N+1クエリ対策（Eager Loading）
- ファイルアップロード時のセキュリティ検証
- 包括的な例外ハンドリング（デコレータパターン）
- パスワード強度検証
- 環境別設定管理と本番環境での必須バリデーション

---

## 詳細ドキュメント

各セキュリティ機能の詳細については、以下のドキュメントを参照してください：

### 1. [認証・認可](./03-security-authentication.md)

- パスワードハッシュ化（bcrypt）
- JWT認証（HS256）
- パスワード強度検証
- 認証依存性注入
- APIキー生成

### 2. [リクエスト保護](./03-security-request-protection.md)

- CORS設定（環境別）
- レート制限（Redis Sorted Set）
- 入力バリデーション（Pydantic）
- ファイル名サニタイゼーション

### 3. [データ保護](./03-security-data-protection.md)

- データベースセキュリティ（SQLAlchemy ORM）
- SQLインジェクション対策
- トランザクション管理
- ファイルアップロードセキュリティ

### 4. [インフラストラクチャ](./03-security-infrastructure.md)

- エラーハンドリング
- 統一エラーレスポンス
- 環境設定管理
- セキュリティヘッダー

### 5. [ベストプラクティス](./03-security-best-practices.md)

- 優先度別の推奨事項
- セキュリティヘッダーミドルウェア
- HTTPS強制
- ログイン失敗回数制限
- APIキー認証
- リフレッシュトークン
- 監査ログ

---

## まとめ

### セキュリティ実装状況

このFastAPIプロジェクトは、包括的なセキュリティ要件を満たしており、以下の点で優れています:

**認証・認可**:

- JWT認証とbcryptパスワードハッシュ化
- リフレッシュトークン（ハッシュ化保存で漏洩対策）
- APIキー認証（ハッシュ化保存）
- ログイン失敗回数制限（ブルートフォース攻撃対策）

**通信・リクエスト保護**:

- セキュリティヘッダーミドルウェア（X-Frame-Options、HSTS等）
- Redisベースのレート制限（スライディングウィンドウ）
- 環境別CORS設定と本番環境での厳格な制御

**データ保護**:

- SQLAlchemy ORMによるSQLインジェクション対策
- N+1クエリ対策（パフォーマンスとセキュリティ）
- トランザクション管理と自動ロールバック
- ファイルアップロード時のセキュリティ検証

**運用・保守性**:

- 包括的な例外ハンドリング（デコレータパターンでDRY）
- 環境別設定管理と本番環境での必須バリデーション
- パスワード強度検証

### 追加推奨事項

さらに堅牢なシステムにするための将来的な検討項目:

1. **監査ログの強化**（優先度：中）- セキュリティイベントの詳細記録とアラート
2. **ファイルスキャン機能**（優先度：低）- アップロードファイルのウイルススキャン
3. **CSRFトークン**（優先度：低）- フォーム送信がある場合のみ

---

## 参考資料

### 主要セキュリティファイル

- `src/app/core/security/`: 認証・認可の中核（password.py, jwt.py, api_key.py）
- `src/app/core/app_factory.py`: ミドルウェア設定
- `src/app/api/middlewares/rate_limit.py`: レート制限
- `src/app/config.py`: 環境設定管理
- `src/app/database.py`: データベース接続とトランザクション管理

### セキュリティ依存関係（pyproject.toml）

```toml
"passlib[bcrypt]>=1.7.4"              # パスワードハッシュ化
"python-jose[cryptography]>=3.3.0"    # JWT生成・検証
"redis[hiredis]>=6.4.0"               # レート制限用キャッシュ
"pydantic[email]>=2.0.0"              # メールバリデーション
"pydantic-settings>=2.6.0"            # 設定管理
```
